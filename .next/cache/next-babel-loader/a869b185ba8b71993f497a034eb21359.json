{"ast":null,"code":"\"use strict\";\n\nvar _mongodb = _interopRequireDefault(require(\"../../middleware/mongodb.js\"));\n\nvar _isomorphicUnfetch = _interopRequireDefault(require(\"isomorphic-unfetch\"));\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\n// The main, exported, function of the endpoint,\n// dealing with the request and subsequent response\nmodule.exports = async (req, res) => {\n  // Get a database connection, cached or otherwise,\n  // using the connection string environment variable as the argument\n  const db = await (0, _mongodb.default)(); // Select the \"stores\" collection from the database\n\n  const collection = await db.collection('stores'); // Select the stores collection from the database\n\n  const stores = await collection.find({\n    $or: [{\n      lat: null\n    }, {\n      lng: null\n    }]\n  }).toArray();\n  let counter = 0;\n\n  for (let index = 0; index < stores.length; index++) {\n    const element = stores[index];\n    const googlemaps_address = element.googlemaps_address;\n\n    if (googlemaps_address != null && googlemaps_address != \"\") {\n      let url = process.env.GOOGLE_MAPS_API_URL + \"?address=\" + googlemaps_address + \"&key=\" + process.env.GOOGLE_MAPS_API_KEY;\n      let res = await (0, _isomorphicUnfetch.default)(url);\n      let jres = await res.json();\n      let place = jres.results[0];\n\n      if (place != null) {\n        collection.update({\n          _id: element._id\n        }, {\n          $set: {\n            lat: place.geometry.location.lat,\n            lng: place.geometry.location.lng,\n            googlemaps_formatted_address: place.formatted_address,\n            googlemaps_place_id: place.place_id\n          }\n        });\n        counter++;\n      } else {\n        console.log(googlemaps_address);\n        console.log(jres);\n      }\n    }\n  } // Respond with a JSON string of all stores in the collection\n\n\n  res.status(200).json({\n    updated_entities: counter\n  });\n};","map":{"version":3,"sources":["/home/crmock/pideenlaequina/front/pages/api/addresses.js"],"names":["module","exports","req","res","db","collection","stores","find","$or","lat","lng","toArray","counter","index","length","element","googlemaps_address","url","process","env","GOOGLE_MAPS_API_URL","GOOGLE_MAPS_API_KEY","jres","json","place","results","update","_id","$set","geometry","location","googlemaps_formatted_address","formatted_address","googlemaps_place_id","place_id","console","log","status","updated_entities"],"mappings":";;AAAA;;AACA;;;;AAEA;AACA;AACAA,MAAM,CAACC,OAAP,GAAiB,OAAOC,GAAP,EAAYC,GAAZ,KAAoB;AACnC;AACA;AACA,QAAMC,EAAE,GAAG,MAAM,uBAAjB,CAHmC,CAKnC;;AACA,QAAMC,UAAU,GAAG,MAAMD,EAAE,CAACC,UAAH,CAAc,QAAd,CAAzB,CANmC,CAQnC;;AACA,QAAMC,MAAM,GAAG,MAAMD,UAAU,CAACE,IAAX,CAAgB;AAAEC,IAAAA,GAAG,EAAC,CAAC;AAACC,MAAAA,GAAG,EAAC;AAAL,KAAD,EAAa;AAACC,MAAAA,GAAG,EAAC;AAAL,KAAb;AAAN,GAAhB,EAAkDC,OAAlD,EAArB;AACA,MAAIC,OAAO,GAAG,CAAd;;AACA,OAAK,IAAIC,KAAK,GAAG,CAAjB,EAAoBA,KAAK,GAAGP,MAAM,CAACQ,MAAnC,EAA2CD,KAAK,EAAhD,EAAoD;AAClD,UAAME,OAAO,GAAGT,MAAM,CAACO,KAAD,CAAtB;AACA,UAAMG,kBAAkB,GAAGD,OAAO,CAACC,kBAAnC;;AAEA,QAAGA,kBAAkB,IAAE,IAApB,IAA4BA,kBAAkB,IAAE,EAAnD,EACA;AAEE,UAAIC,GAAG,GAAGC,OAAO,CAACC,GAAR,CAAYC,mBAAZ,GAAkC,WAAlC,GAA8CJ,kBAA9C,GAAiE,OAAjE,GAAyEE,OAAO,CAACC,GAAR,CAAYE,mBAA/F;AACA,UAAIlB,GAAG,GAAG,MAAM,gCAAMc,GAAN,CAAhB;AACA,UAAIK,IAAI,GAAG,MAAMnB,GAAG,CAACoB,IAAJ,EAAjB;AAEA,UAAIC,KAAK,GAAGF,IAAI,CAACG,OAAL,CAAa,CAAb,CAAZ;;AAEA,UAAGD,KAAK,IAAE,IAAV,EACA;AACEnB,QAAAA,UAAU,CAACqB,MAAX,CAAkB;AAACC,UAAAA,GAAG,EAACZ,OAAO,CAACY;AAAb,SAAlB,EAAqC;AAACC,UAAAA,IAAI,EAAC;AAACnB,YAAAA,GAAG,EAACe,KAAK,CAACK,QAAN,CAAeC,QAAf,CAAwBrB,GAA7B;AAAkCC,YAAAA,GAAG,EAACc,KAAK,CAACK,QAAN,CAAeC,QAAf,CAAwBpB,GAA9D;AAAmEqB,YAAAA,4BAA4B,EAACP,KAAK,CAACQ,iBAAtG;AAAyHC,YAAAA,mBAAmB,EAACT,KAAK,CAACU;AAAnJ;AAAN,SAArC;AACAtB,QAAAA,OAAO;AACR,OAJD,MAKI;AACFuB,QAAAA,OAAO,CAACC,GAAR,CAAYpB,kBAAZ;AACAmB,QAAAA,OAAO,CAACC,GAAR,CAAYd,IAAZ;AACD;AACF;AACF,GAlCkC,CAoCnC;;;AACAnB,EAAAA,GAAG,CAACkC,MAAJ,CAAW,GAAX,EAAgBd,IAAhB,CAAqB;AAACe,IAAAA,gBAAgB,EAAC1B;AAAlB,GAArB;AACD,CAtCD","sourcesContent":["import Database from '../../middleware/mongodb.js'\nimport fetch from 'isomorphic-unfetch'\n\n// The main, exported, function of the endpoint,\n// dealing with the request and subsequent response\nmodule.exports = async (req, res) => {\n  // Get a database connection, cached or otherwise,\n  // using the connection string environment variable as the argument\n  const db = await Database()\n\n  // Select the \"stores\" collection from the database\n  const collection = await db.collection('stores')\n\n  // Select the stores collection from the database\n  const stores = await collection.find({ $or:[{lat:null}, {lng:null}] }).toArray()\n  let counter = 0\n  for (let index = 0; index < stores.length; index++) {\n    const element = stores[index]\n    const googlemaps_address = element.googlemaps_address;\n\n    if(googlemaps_address!=null && googlemaps_address!=\"\")\n    {\n      \n      let url = process.env.GOOGLE_MAPS_API_URL + \"?address=\"+googlemaps_address+\"&key=\"+process.env.GOOGLE_MAPS_API_KEY\n      let res = await fetch(url)\n      let jres = await res.json()\n\n      let place = jres.results[0]\n\n      if(place!=null)\n      {\n        collection.update({_id:element._id}, {$set:{lat:place.geometry.location.lat, lng:place.geometry.location.lng, googlemaps_formatted_address:place.formatted_address, googlemaps_place_id:place.place_id}});\n        counter++\n      }\n      else{\n        console.log(googlemaps_address)\n        console.log(jres)\n      }\n    } \n  }\n\n  // Respond with a JSON string of all stores in the collection\n  res.status(200).json({updated_entities:counter})\n}"]},"metadata":{},"sourceType":"script"}
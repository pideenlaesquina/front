{"ast":null,"code":"\"use strict\";\n\nvar _mongodb = _interopRequireDefault(require(\"../../middleware/mongodb.js\"));\n\nvar _isomorphicUnfetch = _interopRequireDefault(require(\"isomorphic-unfetch\"));\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nconst fs = require('fs'); // The main, exported, function of the endpoint,\n// dealing with the request and subsequent response\n\n\nmodule.exports = async (req, res) => {\n  // Get a database connection, cached or otherwise,\n  // using the connection string environment variable as the argument\n  const db = await (0, _mongodb.default)(); // Select the \"stores\" collection from the database\n\n  const collection = await db.collection('stores2');\n  let rawdata = fs.readFileSync('./../bavaria-fixed.json');\n  let stores = JSON.parse(rawdata);\n  let counter = 0;\n\n  for (let index = 0; index < stores.length; index++) {\n    const element = stores[index];\n    const store = await collection.findOne({\n      name: element.name\n    });\n\n    if (!store) {\n      let url = \"https://maps.googleapis.com/maps/api/geocode/json?latlng=\" + element.lat + \",\" + element.lng + \"&key=\" + process.env.GOOGLE_MAPS_API_KEY;\n      let res = await (0, _isomorphicUnfetch.default)(url);\n      let jres = await res.json();\n      let place = jres.results[0];\n      collection.insert({\n        lat: element.lat,\n        lng: element.lng,\n        googlemaps_lat: place.geometry.location.lat,\n        googlemaps_lng: place.geometry.location.lng,\n        googlemaps_formatted_address: place.formatted_address,\n        googlemaps_place_id: place.place_id,\n        googlemaps_compound_code: place.plus_code ? place.plus_code.compound_code : null,\n        name: element.name,\n        country_code: \"CO\",\n        cellphone: element.cellphone.length == 10 ? element.cellphone : \"\",\n        telephone: element.cellphone.length != 10 ? element.cellphone : \"\",\n        address: element.address\n      });\n      counter++;\n    } else {\n      console.log(element.name);\n    }\n  } // Respond with a JSON string of all stores in the collection\n\n\n  res.status(200).json({\n    uploaded_entities: counter\n  });\n};","map":{"version":3,"sources":["/home/crmock/pideenlaequina/front/pages/api/upload.js"],"names":["fs","require","module","exports","req","res","db","collection","rawdata","readFileSync","stores","JSON","parse","counter","index","length","element","store","findOne","name","url","lat","lng","process","env","GOOGLE_MAPS_API_KEY","jres","json","place","results","insert","googlemaps_lat","geometry","location","googlemaps_lng","googlemaps_formatted_address","formatted_address","googlemaps_place_id","place_id","googlemaps_compound_code","plus_code","compound_code","country_code","cellphone","telephone","address","console","log","status","uploaded_entities"],"mappings":";;AAAA;;AACA;;;;AAEA,MAAMA,EAAE,GAAGC,OAAO,CAAC,IAAD,CAAlB,C,CAEA;AACA;;;AACAC,MAAM,CAACC,OAAP,GAAiB,OAAOC,GAAP,EAAYC,GAAZ,KAAoB;AACnC;AACA;AACA,QAAMC,EAAE,GAAG,MAAM,uBAAjB,CAHmC,CAKnC;;AACA,QAAMC,UAAU,GAAG,MAAMD,EAAE,CAACC,UAAH,CAAc,SAAd,CAAzB;AAEA,MAAIC,OAAO,GAAGR,EAAE,CAACS,YAAH,CAAgB,yBAAhB,CAAd;AACA,MAAIC,MAAM,GAAGC,IAAI,CAACC,KAAL,CAAWJ,OAAX,CAAb;AAEA,MAAIK,OAAO,GAAG,CAAd;;AACA,OAAK,IAAIC,KAAK,GAAG,CAAjB,EAAoBA,KAAK,GAAGJ,MAAM,CAACK,MAAnC,EAA2CD,KAAK,EAAhD,EAAoD;AAClD,UAAME,OAAO,GAAGN,MAAM,CAACI,KAAD,CAAtB;AACA,UAAMG,KAAK,GAAG,MAAMV,UAAU,CAACW,OAAX,CAAmB;AAACC,MAAAA,IAAI,EAAEH,OAAO,CAACG;AAAf,KAAnB,CAApB;;AACA,QAAG,CAACF,KAAJ,EACA;AACI,UAAIG,GAAG,GAAG,8DAA4DJ,OAAO,CAACK,GAApE,GAAwE,GAAxE,GAA4EL,OAAO,CAACM,GAApF,GAAwF,OAAxF,GAAgGC,OAAO,CAACC,GAAR,CAAYC,mBAAtH;AAEA,UAAIpB,GAAG,GAAG,MAAM,gCAAMe,GAAN,CAAhB;AACA,UAAIM,IAAI,GAAG,MAAMrB,GAAG,CAACsB,IAAJ,EAAjB;AAEA,UAAIC,KAAK,GAAGF,IAAI,CAACG,OAAL,CAAa,CAAb,CAAZ;AAEAtB,MAAAA,UAAU,CAACuB,MAAX,CAAkB;AACdT,QAAAA,GAAG,EAEHL,OAAO,CAACK,GAHM;AAIdC,QAAAA,GAAG,EAACN,OAAO,CAACM,GAJE;AAKdS,QAAAA,cAAc,EAACH,KAAK,CAACI,QAAN,CAAeC,QAAf,CAAwBZ,GALzB;AAMda,QAAAA,cAAc,EAACN,KAAK,CAACI,QAAN,CAAeC,QAAf,CAAwBX,GANzB;AAOda,QAAAA,4BAA4B,EAACP,KAAK,CAACQ,iBAPrB;AAQdC,QAAAA,mBAAmB,EAACT,KAAK,CAACU,QARZ;AASdC,QAAAA,wBAAwB,EAAEX,KAAK,CAACY,SAAN,GAAgBZ,KAAK,CAACY,SAAN,CAAgBC,aAAhC,GAA8C,IAT1D;AAUdtB,QAAAA,IAAI,EAACH,OAAO,CAACG,IAVC;AAWduB,QAAAA,YAAY,EAAC,IAXC;AAYdC,QAAAA,SAAS,EAAE3B,OAAO,CAAC2B,SAAR,CAAkB5B,MAAlB,IAA0B,EAA1B,GAA6BC,OAAO,CAAC2B,SAArC,GAA+C,EAZ5C;AAadC,QAAAA,SAAS,EAAE5B,OAAO,CAAC2B,SAAR,CAAkB5B,MAAlB,IAA0B,EAA1B,GAA6BC,OAAO,CAAC2B,SAArC,GAA+C,EAb5C;AAcdE,QAAAA,OAAO,EAAC7B,OAAO,CAAC6B;AAdF,OAAlB;AAgBAhC,MAAAA,OAAO;AACV,KA1BD,MA2BI;AACAiC,MAAAA,OAAO,CAACC,GAAR,CAAY/B,OAAO,CAACG,IAApB;AACH;AACF,GA7CkC,CA+CnC;;;AACAd,EAAAA,GAAG,CAAC2C,MAAJ,CAAW,GAAX,EAAgBrB,IAAhB,CAAqB;AAACsB,IAAAA,iBAAiB,EAACpC;AAAnB,GAArB;AACD,CAjDD","sourcesContent":["import Database from '../../middleware/mongodb.js'\nimport fetch from 'isomorphic-unfetch'\n\nconst fs = require('fs');\n\n// The main, exported, function of the endpoint,\n// dealing with the request and subsequent response\nmodule.exports = async (req, res) => {\n  // Get a database connection, cached or otherwise,\n  // using the connection string environment variable as the argument\n  const db = await Database()\n\n  // Select the \"stores\" collection from the database\n  const collection = await db.collection('stores2')\n\n  let rawdata = fs.readFileSync('./../bavaria-fixed.json');\n  let stores = JSON.parse(rawdata);\n\n  let counter = 0\n  for (let index = 0; index < stores.length; index++) {\n    const element = stores[index]  \n    const store = await collection.findOne({name: element.name })\n    if(!store)\n    {\n        let url = \"https://maps.googleapis.com/maps/api/geocode/json?latlng=\"+element.lat+\",\"+element.lng+\"&key=\"+process.env.GOOGLE_MAPS_API_KEY\n\n        let res = await fetch(url)\n        let jres = await res.json()\n\n        let place = jres.results[0]\n\n        collection.insert({\n            lat:\n            \n            element.lat, \n            lng:element.lng, \n            googlemaps_lat:place.geometry.location.lat, \n            googlemaps_lng:place.geometry.location.lng, \n            googlemaps_formatted_address:place.formatted_address, \n            googlemaps_place_id:place.place_id,\n            googlemaps_compound_code:(place.plus_code?place.plus_code.compound_code:null),\n            name:element.name,\n            country_code:\"CO\",\n            cellphone:(element.cellphone.length==10?element.cellphone:\"\"),\n            telephone:(element.cellphone.length!=10?element.cellphone:\"\"),\n            address:element.address\n        });\n        counter++\n    }\n    else{\n        console.log(element.name)\n    }\n  }\n\n  // Respond with a JSON string of all stores in the collection\n  res.status(200).json({uploaded_entities:counter})\n}"]},"metadata":{},"sourceType":"script"}